<!DOCTYPE html>
<html lang="en">
<head>
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Habit Builder</title>
  <style>
  
  body {
  font-family: 'Nunito', sans-serif;
  background: #ffffff;
  color: #333333;
  margin: 0;
  padding: 0;
}

header {
  text-align: center;
  padding: 2rem;
  background: #f8f9fa;
  border-bottom: 2px solid #e0e0e0;
}

header h1 {
  margin: 0;
  font-size: 2.5rem;
  color: #28b485;
}

header p {
  font-size: 1.2rem;
  color: #666666;
}

main {
  padding: 2rem;
  max-width: 600px;
  margin: 0 auto;
}

section {
  margin-bottom: 2rem;
}

input, button {
  font-size: 1rem;
  padding: 0.75rem;
  margin: 0.5rem 0;
  border-radius: 10px;
  border: 1px solid #e0e0e0;
  width: 100%;
  box-sizing: border-box;
}
    
select {
  font-size: 1rem;
  padding: 0.75rem;
  margin: 0.5rem 0;
  border-radius: 10px;
  border: 1px solid #e0e0e0;
  width: 100%;
  box-sizing: border-box;
  appearance: none;
  background-color: #ffffff;
  color: #333333;
  background-image: url("data:image/svg+xml;charset=US-ASCII,%3Csvg xmlns='http://www.w3.org/2000/svg' width='14' height='10' viewBox='0 0 14 10'%3E%3Cpath fill='%2328b485' d='M7 10L0 0h14z'/%3E%3C/svg%3E");
  background-repeat: no-repeat;
  background-position: right 1rem center;
  background-size: 12px;
}

select:focus {
  outline: none;
  border-color: #28b485;
  box-shadow: 0 0 0 3px rgba(40, 180, 133, 0.15);
}


button {
  background: #28b485;
  border: none;
  color: #ffffff;
  font-weight: bold;
  cursor: pointer;
  transition: background 0.3s;
}

button:hover {
  background: #249e76;
}

#progressBar {
  height: 10px;
  background: #d1f2eb;
  border-radius: 5px;
  overflow: hidden;
  margin: 1rem 0;
}

#progressFill {
  height: 100%;
  background: #28b485;
  width: 0;
  transition: width 0.5s ease;
}

.dashboard {
  background: #f8f9fa;
  padding: 2rem;
  border-radius: 20px;
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
  position: relative;
}

#habitList {
  padding-left: 1rem;
}

.fade-in {
  animation: fadeIn 0.5s ease-in;
}

.fade-out {
  animation: fadeOut 0.5s ease-out;
}

@keyframes fadeIn {
  from {opacity: 0;}
  to {opacity: 1;}
}

@keyframes fadeOut {
  from {opacity: 1;}
  to {opacity: 0;}
}

#welcomePopup h2 {
  color: #28b485;
}

#welcomePopup p {
  color: #666666;
}

#welcomePopup button {
  background: #28b485;
  color: #ffffff;
}

#welcomePopup button:hover {
  background: #249e76;
}

#userTitle {
  position: fixed;
  top: 10px;
  left: 20px;
  font-size: 1.2rem;
  color: #28b485;
  font-weight: bold;
  display: none;
  z-index: 1000;
}
#goal-buttons button.selected,
#motivation-buttons button.selected {
  background-color: #ffc107;
  color: #1a1a1a;
  font-weight: bold;
  border: 2px solid #ffa000;
  transform: scale(1.03);
}



  </style>
</head>
<body>
  <input type="hidden" id="username" />
  <div id="userTitle"></div>

  <header>
    <h1>Habit Builder</h1>
    <p>Visualize. Build. Track. Grow.</p>
  </header>

  <main>
    <section id="auth-section">
      <div class="dashboard">
        <h2>Welcome to Habit Builder 👋</h2>
        <p>Create an account to start your journey:</p>
        <input type="text" id="auth-name" placeholder="Username" /><br />
        <input type="password" id="auth-password" placeholder="Create a password" /><br />
        <input type="password" id="auth-confirm-password" placeholder="Confirm your password" /><br />
        <select id="security-question">
          <option value="" disabled selected>Select a security question</option>
          <option value="What was your childhood nickname?">What was your childhood nickname?</option>
          <option value="In what city were you born?">In what city were you born?</option>
          <option value="What is your favorite movie?">What is your favorite movie?</option>
          <option value="What was your first pet’s name?">What was your first pet’s name?</option>
          <option value="What elementary school did you attend?">What elementary school did you attend?</option>
          <option value="What is your mother’s maiden name?">What is your mother’s maiden name?</option>
          <option value="What was your dream job as a child?">What was your dream job as a child?</option>
          <option value="What is your favorite food?">What is your favorite food?</option>
          <option value="What is your favorite book?">What is your favorite book?</option>
          <option value="What was the make of your first car?">What was the make of your first car?</option>
        </select><br />

        <input type="text" id="security-answer" placeholder="Answer to your question" /><br />
        <button onclick="completeSignup()">Create Account</button>
        <p style="text-align: center;">
          Already have an account? <a href="#" onclick="showLogin()">Log in</a>
        </p>
      </div>
    </section>
    
    <section id="login-section" style="display: none;">
      <div class="dashboard">
        <h2>Welcome Back 👋</h2>
        <p>Log in to continue building your habits:</p>
        <input type="text" id="login-name" placeholder="Your name" /><br />
        <input type="password" id="login-password" placeholder="Your password" /><br />
        <button onclick="loginUser()">Log In</button>
        <p style="text-align: center;">
          <a href="#" onclick="showPasswordReset()">Forgot your password?</a>
        </p>
        <p style="text-align: center;">
          New here? <a href="#" onclick="showSignup()">Create an account</a>
        </p>
      </div>
    </section>
    
    <section id="reset-section" style="display: none;">
      <div class="dashboard">
        <h2>Reset Your Password 🔑</h2>
        <input type="text" id="reset-name" placeholder="Your username" /><br />
        <p id="securityQuestionDisplay" style="font-style: italic; color: #555;"></p>
        <input type="text" id="reset-answer" placeholder="Answer to your security question" style="display: none;" /><br />
        <input type="password" id="new-password" placeholder="New password" style="display: none;" /><br />
        <button onclick="handleReset()" id="resetActionBtn">Next</button><br />
        <p style="text-align: center;">
          <a href="#" onclick="backToLogin()">Back to login</a>
        </p>
      </div>
    </section>
    


    <section id="onboarding" style="display: none;">
      <div id="progressBar">
        <div id="progressFill"></div>
      </div>
      <h2>Hi there!</h2>
      <p>Let’s make a plan just for you. What’s something you want to build into your life?</p>

      <div id="quiz-step-1">
        <p>Choose up to 3 long-term priorities:</p>
        <div id="goal-buttons" style="display: flex; flex-wrap: wrap; gap: 0.5rem;">
          <button onclick="toggleGoal(this, 'Improve Physical Health')">💪 Improve Physical Health</button>
          <button onclick="toggleGoal(this, 'Boost Mental Well-Being')">🧠 Boost Mental Well-Being</button>
          <button onclick="toggleGoal(this, 'Advance Career or Education')">🎓 Advance Career or Education</button>
          <button onclick="toggleGoal(this, 'Build Financial Stability')">💰 Build Financial Stability</button>
          <button onclick="toggleGoal(this, 'Strengthen Relationships')">🤝 Strengthen Relationships</button>
          <button onclick="toggleGoal(this, 'Enhance Creativity or Hobbies')">🎨 Enhance Creativity or Hobbies</button>
          <button onclick="toggleGoal(this, 'Establish a Daily Routine')">📅 Establish a Daily Routine</button>
          <button onclick="toggleGoal(this, 'Minimize Stress & Simplify Life')">🌿 Minimize Stress & Simplify Life</button>
          <button onclick="toggleGoal(this, 'Grow Spiritually or Philosophically')">🕊️ Grow Spiritually or Philosophically</button>
          <button onclick="toggleGoal(this, 'Make a Big Life Change')">🔄 Make a Big Life Change</button>
       </div>
        <input type="text" id="customGoalInput" placeholder="Write your own goal..." style="margin-top: 1rem;" />
        <button style="margin-top: 0.5rem;" onclick="addCustomGoal()">➕ Add Custom Goal</button>
        <br />
        <button id="toStep2Btn" style="display: none; margin-top: 1rem;" onclick="goToStep2()">Next</button>
      </div>

     <div id="quiz-step-2" style="display: none;">
        <p>Which methods help you stick with your habits?</p>
        <div id="motivation-buttons" style="display: flex; flex-direction: column; gap: 0.5rem;">
          <button onclick="toggleMotivation(this, 'Tracking my progress visually')">🔍 Tracking my progress visually</button>
          <button onclick="toggleMotivation(this, 'Accountability from others')">🤝 Accountability from others</button>
          <button onclick="toggleMotivation(this, 'Clear rewards or milestones')">🎯 Clear rewards or milestones</button>
          <button onclick="toggleMotivation(this, 'Visualizing success')">🌟 Visualizing success</button>
          <button onclick="toggleMotivation(this, 'Encouragement and affirmations')">💬 Encouragement and affirmations</button>
          <button onclick="toggleMotivation(this, 'Building habits into my routine')">🧘‍♀️ Building habits into my routine</button>
          <button onclick="toggleMotivation(this, 'Still figuring it out')">🤷 I haven’t figured it out yet</button>
        </div>

        <input type="text" id="customMotivationInput" placeholder="Add your own motivation..." style="margin-top: 1rem;" />
        <button style="margin-top: 0.5rem;" onclick="addCustomMotivation()">➕ Add Custom Motivation</button>
        <br />
        <button id="toShortTermBtn" style="display: none; margin-top: 1rem;" onclick="goToShortTerm()">Next</button>
      </div>


      <br />
      <button id="startBtn" style="display: none;" onclick="startJourney()">Start Your Journey</button>
    </section>

    <section id="dashboard" class="dashboard" style="display: none;">
      <div style="margin-top: 2rem; padding: 1rem; border-top: 1px dashed #ccc;">
        <h4>Developer Controls</h4>
        <button onclick="clearAllUsers()">🗑️ Clear All Users</button>
      </div>

      <h2>Your Dashboard</h2>
      <button onclick="logoutUser()" style="background-color: #f44336; margin-bottom: 1rem;">🚪 Log Out</button>
      <div id="avatar">👤</div>
      <p><strong>Name:</strong> <span id="displayName"></span></p>
      <p><strong>Goal:</strong> <span id="displayGoal"></span></p>

      <div class="habit">
        <h3>Your Habit</h3>
        <input type="text" id="habitInput" placeholder="e.g., Take a walk daily" />
        <button onclick="addHabit()">Add Habit</button>
      </div>

      <ul id="habitList"></ul>
    </section>

    <section id="chatbot" style="display: none;">
      <h2>Chat with HabitBot 🤖</h2>
      <p>(Placeholder: GPT integration here)</p>
    </section>

    <!-- 🌟 Welcome Popup -->
    <div id="welcomePopup" style="display: none;" class="fade-in">
      <div style="
        position: fixed;
        top: 0; left: 0; right: 0; bottom: 0;
        background: rgba(0, 0, 0, 0.3);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 9999;
      ">
        <div style="
          background: #f9f7f2;
          padding: 2rem 3rem;
          border-radius: 20px;
          box-shadow: 0 10px 25px rgba(0,0,0,0.1);
          text-align: center;
          max-width: 90%;
          font-family: 'Nunito', sans-serif;
        ">
          <h2 id="popupGreeting" style="color: #4a4a40;">Hi there!</h2>
          <p style="color: #6e6b5e;">We’re so glad you’re here. Let’s build something great together ✨</p>
          <button onclick="closeWelcome()" style="
            margin-top: 1.5rem;
            padding: 0.75rem 1.5rem;
            font-size: 1rem;
            background: #aacbb0;
            color: #2e3d32;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-weight: bold;
          ">Let’s go!</button>

        </div>
      </div>
    </div>
  </main>

  <script>
    function handleReset() {
      const btn = document.getElementById("resetActionBtn");
      const name = document.getElementById("reset-name").value.trim().toLowerCase();
      const answer = document.getElementById("reset-answer").value.trim().toLowerCase();
      const newPassword = document.getElementById("new-password").value;
    
      // Step 1: Lookup user and show question
      if (!resetUserMatch) {
        const users = getUserDB();
        resetUserMatch = users.find(user => user.name.toLowerCase() === name);
    
        if (!resetUserMatch) {
          alert("No user found with that name.");
          return;
        }
    
        document.getElementById("securityQuestionDisplay").textContent = resetUserMatch.question;
        document.getElementById("reset-answer").style.display = "block";
        document.getElementById("new-password").style.display = "block";
        btn.textContent = "Reset Password";
        return;
      }
    
      // Step 2: Validate answer and reset password
      if (hashPassword(answer) !== resetUserMatch.answer) {
        alert("Incorrect answer to the security question.");
        return;
      }
    
      if (!newPassword) {
        alert("Please enter a new password.");
        return;
      }
    
      const users = getUserDB();
      const userIndex = users.findIndex(u => u.name === resetUserMatch.name);
      users[userIndex].password = hashPassword(newPassword);
      saveUserDB(users);
    
      alert("Password successfully reset! Please log in.");
      resetUserMatch = null;
      document.getElementById("resetActionBtn").textContent = "Next";
      document.getElementById("reset-answer").style.display = "none";
      document.getElementById("new-password").style.display = "none";
      document.getElementById("securityQuestionDisplay").textContent = "";
      document.getElementById("reset-name").value = "";
      document.getElementById("reset-answer").value = "";
      document.getElementById("new-password").value = "";
    
      backToLogin();
    }

    let resetUserMatch = null;

    function showPasswordReset() {
      document.getElementById("login-section").style.display = "none";
      document.getElementById("reset-section").style.display = "block";
    }
    
    function backToLogin() {
      document.getElementById("reset-section").style.display = "none";
      document.getElementById("login-section").style.display = "block";
    }

    function showLogin() {
      document.getElementById("auth-section").style.display = "none";
      document.getElementById("login-section").style.display = "block";
    }
    
    function showSignup() {
      document.getElementById("login-section").style.display = "none";
      document.getElementById("auth-section").style.display = "block";
    }
    
    function loginUser() {
      const loginName = document.getElementById("login-name").value.trim();
      const loginPassword = document.getElementById("login-password").value;
    
      if (!loginName || !loginPassword) {
        alert("Please enter both username and password.");
        return;
      }
    
      const users = getUserDB();
      const match = users.find(user => 
        user.name.toLowerCase() === loginName.toLowerCase() &&
        user.password === hashPassword(loginPassword)
      );
    
      if (!match) {
        alert("Invalid username or password.");
        return;
      }
    
      userName = loginName;
    
      document.getElementById("popupGreeting").innerText = `Welcome back, ${userName}!`;
      document.getElementById("welcomePopup").style.display = "block";
    
      confetti({
        particleCount: 100,
        spread: 80,
        origin: { y: 0.6 }
      });

      localStorage.setItem("hasOnboarded_" + userName, "true");
      localStorage.setItem("lastUser", userName);

    
      setTimeout(() => {
        document.getElementById("welcomePopup").style.display = "none";
        document.getElementById("auth-section").style.display = "none";
        document.getElementById("login-section").style.display = "none";
        document.getElementById("onboarding").style.display = "block";
        document.getElementById("onboarding").classList.add("fade-in");
        document.getElementById("username").value = userName;
      }, 1500);
    }
    
        


    let selectedLongTermGoal = "";
    function hashPassword(password) {
      return btoa(password); // Just for demo – not secure
    }
    
    function getUserDB() {
      return JSON.parse(localStorage.getItem("habitUsers") || "[]");
    }
    
    function saveUserDB(users) {
      localStorage.setItem("habitUsers", JSON.stringify(users));
    }

    let selectedShortTermGoal = "";
    let userName = "";
    let selectedGoals = [];

    const shortTermGoalsMap = {
      "Improve Physical Health": [
        "🚶 Walk 7,000+ steps today",
        "🥦 Eat a veggie with every meal",
        "💧 Drink 8 cups of water",
        "🏋️ Do a 20-minute workout",
        "🧘 Stretch for 10 minutes"
      ],
      "Boost Mental Well-Being": [
        "📓 Journal for 5 minutes tonight",
        "🧘 Meditate for 10 minutes",
        "🌅 Go for a mindful morning walk",
        "📵 Unplug from screens 1 hour before bed",
        "🎧 Listen to calming music during lunch"
      ],
      "Advance Career or Education": [
        "📚 Study or read for 30 minutes",
        "📅 Plan your week in Google Calendar",
        "📝 Apply to one opportunity",
        "👨‍🏫 Attend a virtual webinar or event",
        "✅ Check off one thing on your to-do list"
      ],
      "Build Financial Stability": [
        "💸 Track today’s spending",
        "🏦 Transfer $5 to savings",
        "🧾 Review 3 recent transactions",
        "📈 Update your budget or spreadsheet",
        "🛍️ Skip a non-essential purchase today"
      ],
      "Strengthen Relationships": [
        "📱 Text or call a friend/family member",
        "👥 Schedule a hangout",
        "💌 Send a thoughtful message",
        "🧠 Remember a friend’s upcoming event",
        "🎁 Plan a small surprise for someone"
      ],
      "Enhance Creativity or Hobbies": [
        "🎨 Create for 20 minutes",
        "📷 Take a creative photo today",
        "📝 Write something short (poem, journal)",
        "🎧 Listen to an inspiring podcast",
        "📚 Read or watch something for inspiration"
      ],
      "Establish a Daily Routine": [
        "🛏️ Wake up at a consistent time",
        "📅 Fill out your daily plan",
        "🍽️ Eat meals at regular times",
        "🧼 Do one routine chore (dishes, laundry)",
        "🔁 Repeat one habit from yesterday"
      ],
      "Minimize Stress & Simplify Life": [
        "🗑️ Declutter one space (desk, bag, folder)",
        "🧘 Breathe deeply for 3 minutes",
        "📵 Turn off notifications for 1 hour",
        "📝 Do a 5-minute brain dump",
        "🕰️ Time-block your next 2 hours"
      ],
      "Grow Spiritually or Philosophically": [
        "📖 Read a page of a spiritual or wisdom text",
        "🙏 Reflect on 1 thing you're grateful for",
        "🌌 Watch the sunset or stargaze",
        "🧘 Meditate with intention (even 5 min)",
        "🪞 Ask yourself a deep question & journal"
      ],
      "Make a Big Life Change": [
        "🧭 Write out your ideal day 1 year from now",
        "📋 List 3 next steps for your goal",
        "📅 Schedule time to work on a transition",
        "📞 Call someone who’s done it before",
        "🧼 Let go of one thing that’s holding you back"
      ]
    };

    function toggleGoal(button, goal) {
      const index = selectedGoals.indexOf(goal);
      if (index > -1) {
        selectedGoals.splice(index, 1);
        button.classList.remove("selected");
      } else {
        if (selectedGoals.length >= 3) {
          alert("You can only choose up to 3 goals.");
          return;
        }
        selectedGoals.push(goal);
        button.classList.add("selected");
      }
  
    
      
      document.getElementById("toStep2Btn").style.display = selectedGoals.length > 0 ? "inline-block" : "none";
    }

    function addCustomGoal() {
      const input = document.getElementById("customGoalInput");
      const goal = input.value.trim();
      if (!goal) {
        alert("Please enter a custom goal.");
        return;
      }
      if (selectedGoals.includes(goal)) {
        alert("You already added this goal.");
        return;
      }
      if (selectedGoals.length >= 3) {
        alert("You can only choose up to 3 goals.");
        return;
      }
    
      const newBtn = document.createElement("button");
      newBtn.textContent = `✨ ${goal}`;
      newBtn.classList.add("selected");
      newBtn.onclick = () => {
        selectedGoals = selectedGoals.filter(g => g !== goal);
        newBtn.remove();
        document.getElementById("toStep2Btn").style.display = selectedGoals.length > 0 ? "inline-block" : "none";
      };
    
      document.getElementById("goal-buttons").appendChild(newBtn);
      selectedGoals.push(goal);
      input.value = "";
    
      document.getElementById("toStep2Btn").style.display = "inline-block";
    }
  
    let selectedMotivations = [];
    

function toggleMotivation(button, motivation) {
  const index = selectedMotivations.indexOf(motivation);

  if (index > -1) {
    selectedMotivations.splice(index, 1);
    button.classList.remove("selected");
  } else {
    if (selectedMotivations.length >= 2) {
      alert("Please pick up to 2 motivation styles.");
      return;
    }
    selectedMotivations.push(motivation);
    button.classList.add("selected");
  }

  document.getElementById("toShortTermBtn").style.display = selectedMotivations.length > 0 ? "inline-block" : "none";
}

function toggleShortTerm(button, goal) {
  const index = selectedShortTermGoals.indexOf(goal);

  if (index > -1) {
    selectedShortTermGoals.splice(index, 1);
    button.classList.remove("selected");
  } else {
    if (selectedShortTermGoals.length >= 3) {
      alert("You can only pick up to 3 short-term habits.");
      return;
    }
    selectedShortTermGoals.push(goal);
    button.classList.add("selected");
  }

  document.getElementById("toStartBtn").style.display = selectedShortTermGoals.length > 0 ? "inline-block" : "none";
}



function addCustomMotivation() {
  const input = document.getElementById("customMotivationInput");
  const motivation = input.value.trim();
  if (!motivation) {
    alert("Please enter a custom motivation.");
    return;
  }
  if (selectedMotivations.includes(motivation)) {
    alert("You already added this motivation.");
    return;
  }
  if (selectedMotivations.length >= 2) {
    alert("Please pick up to 2 motivation styles.");
    return;
  }

  const newBtn = document.createElement("button");
  newBtn.textContent = `✨ ${motivation}`;
  newBtn.classList.add("selected");
  newBtn.onclick = () => {
    selectedMotivations = selectedMotivations.filter(m => m !== motivation);
    newBtn.remove();
    document.getElementById("toShortTermBtn").style.display = selectedMotivations.length > 0 ? "inline-block" : "none";
  };

  document.getElementById("motivation-buttons").appendChild(newBtn);
  selectedMotivations.push(motivation);
  input.value = "";

  document.getElementById("toShortTermBtn").style.display = "inline-block";
}
    
async function getShortTermGoalsFromGPT(longTermGoals) {
  const response = await fetch("https://3796630f-a725-4b25-8ff8-8cdd75c3da82-00-w6gk5ernoe72.spock.replit.dev/generate-goals", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ goals: longTermGoals })
  });

  const data = await response.json();

  // ✅ SAFELY CHECK if choices exist
  if (!data.choices || !data.choices[0] || !data.choices[0].message) {
    throw new Error("Invalid GPT response.");
  }

  const text = data.choices[0].message.content;
  return text.split("\n").filter(line => line.trim()).slice(0, 3);
}


let selectedShortTermGoals = [];

async function goToShortTerm() {
  updateProgress(85);
  document.getElementById("quiz-step-2").style.display = "none";

  const shortTermSection = document.createElement("div");
  shortTermSection.id = "quiz-step-3";
  shortTermSection.innerHTML = `<p>Loading personalized short-term goals...</p>`;
  document.getElementById("onboarding").appendChild(shortTermSection);

  const gptSuggestions = await getShortTermGoalsFromGPT(selectedGoals);

   shortTermSection.innerHTML = `
    <p>Pick up to <strong>3 short-term habits</strong> to work on this week:</p>
    <div id="shortterm-buttons" style="display: flex; flex-wrap: wrap; gap: 0.5rem;">
      ${gptSuggestions.map(goal => `<button onclick="toggleShortTerm(this, '${goal.replace(/'/g, "\\'")}')">${goal}</button>`).join('')}
    </div>
    <input type="text" id="customShortTermInput" placeholder="Or write your own..." style="margin-top: 1rem;" />
    <button style="margin-top: 0.5rem;" onclick="addCustomShortTermGoal()">➕ Add Custom Goal</button>
    <br />
    <button id="toStartBtn" style="display: none; margin-top: 1rem;" onclick="prepareStart()">Next</button>
  `;

}



    
    function goToStep2() {
      updateProgress(66);
      document.getElementById("quiz-step-1").style.display = "none";
      document.getElementById("quiz-step-2").style.display = "block";
      document.querySelector("#onboarding h2").innerText = "Let's personalize your journey!";
      document.querySelector("#onboarding p").innerText = "Which methods help you stick with your habits?";
    }

    function completeSignup() {
      const nameInput = document.getElementById("auth-name").value.trim();
      const password = document.getElementById("auth-password").value;
      const confirmPassword = document.getElementById("auth-confirm-password").value;
      
      if (!nameInput || !password || !confirmPassword) {
        alert("Please complete all fields.");
        return;
      }
      
      if (password !== confirmPassword) {
        alert("Passwords do not match.");
        return;
      }
    
      const users = getUserDB();
      const userExists = users.some(user => user.name.toLowerCase() === nameInput.toLowerCase());
    
      if (userExists) {
        alert("Username already taken.");
        return;
      }
    
      const question = document.getElementById("security-question").value.trim();
      const answer = document.getElementById("security-answer").value.trim();
      
      if (question === "" || !answer) {
        alert("Please select a security question and provide an answer.");
        return;
      }
    
      
      users.push({
        name: nameInput,
        password: hashPassword(password),
        question,
        answer: hashPassword(answer.toLowerCase())
      });
      
    
      saveUserDB(users);
    
      userName = nameInput;
      if (userName === "Aiyanna") {
        const devTools = document.createElement("div");
        devTools.innerHTML = `
          <h4>Developer Controls</h4>
          <button onclick="clearAllUsers()">🗑️ Clear All Users</button>
        `;
        document.getElementById("dashboard").appendChild(devTools);
      }
      document.getElementById("popupGreeting").innerText = `Hi, ${userName}!`;
      document.getElementById("welcomePopup").style.display = "block";
    
      confetti({
        particleCount: 100,
        spread: 80,
        origin: { y: 0.6 }
      });
    }


    
    function closeWelcome() {
      document.getElementById("welcomePopup").classList.add("fade-out");
      setTimeout(() => {
        document.getElementById("welcomePopup").style.display = "none";
        document.getElementById("auth-section").style.display = "none";
        document.getElementById("login-section").style.display = "none";
        document.getElementById("onboarding").style.display = "block";
        document.getElementById("onboarding").classList.add("fade-in");
        document.getElementById("username").value = userName;
      }, 500);
    }

    function updateProgress(percent) {
      document.getElementById("progressFill").style.width = percent + "%";
    }

    function setLongTermGoal(goal) {
      selectedLongTermGoal = goal;
      updateProgress(66);
      
      document.getElementById("customGoal").style.display = "block";
      document.getElementById("quiz-step-1").style.display = "none";
      document.getElementById("quiz-step-2").style.display = "block";
    }

    function setShortTermGoal(goal) {
      selectedShortTermGoal = goal;
      updateProgress(100);
      document.getElementById("quiz-step-2").style.display = "none";
      document.getElementById("startBtn").style.display = "inline-block";
    }

    function addCustomShortTermGoal() {
      const input = document.getElementById("customShortTermInput");
      const goal = input.value.trim();
      if (!goal) {
        alert("Please enter a short-term goal.");
        return;
      }
      if (selectedShortTermGoals.includes(goal)) {
        alert("You already added this goal.");
        return;
      }
      if (selectedShortTermGoals.length >= 3) {
        alert("You can only pick up to 3 short-term habits.");
        return;
      }
    
      const newBtn = document.createElement("button");
      newBtn.textContent = `✨ ${goal}`;
      newBtn.onclick = function() {
        toggleShortTerm(newBtn, goal);
      };
      document.getElementById("shortterm-buttons").appendChild(newBtn);
      
      // 💥 ADD THIS:
      toggleShortTerm(newBtn, goal);
    
      input.value = "";
    }

    
    
        function startJourney() {
          const customGoalElement = document.getElementById("customGoalInput");
          const customGoalInput = customGoalElement ? customGoalElement.value : "";
    
    
          if (!userName || !selectedGoals.length || !selectedShortTermGoals.length) {
            alert("Please complete all steps!");
            return;
          }

      document.getElementById("onboarding").classList.add("fade-out");
      setTimeout(() => {
        document.getElementById("onboarding").style.display = "none";
        document.getElementById("dashboard").style.display = "block";
        document.getElementById("dashboard").classList.add("fade-in");
        document.getElementById("chatbot").style.display = "block";

        document.getElementById("displayName").innerText = userName;
        document.getElementById("displayGoal").innerText =
          `Long-term: ${selectedGoals.join(", ")}${customGoalInput ? ` (${customGoalInput})` : ''}, ` +
          `Motivation: ${selectedMotivations.join(", ")}, ` +
          `Short-term: ${selectedShortTermGoals.join(", ")}`;



        const userTitle = document.getElementById("userTitle");
        userTitle.innerText = `${userName}'s habits`;
        userTitle.style.display = "block";
      }, 600);
    }

    function addHabit() {
      const habit = document.getElementById("habitInput").value;
      if (habit) {
        const listItem = document.createElement("li");
        listItem.textContent = habit;
        document.getElementById("habitList").appendChild(listItem);
        document.getElementById("habitInput").value = "";
      }
    }
    function logoutUser() {
      const confirmLogout = confirm("Are you sure you want to log out?");
      if (confirmLogout) {
        localStorage.removeItem("lastUser");
        userName = "";
        // You could also clear selected goals if you want:
        selectedGoals = [];
        selectedMotivations = [];
        selectedShortTermGoal = "";
        selectedLongTermGoal = "";
    
        // Hide dashboard, show login
        document.getElementById("dashboard").style.display = "none";
        document.getElementById("chatbot").style.display = "none";
        document.getElementById("userTitle").style.display = "none";
        document.getElementById("login-section").style.display = "block";
    
        alert("You have been logged out!");
      }
    }

    function clearAllUsers() {
      const confirmClear = confirm("Are you sure you want to delete all users? This cannot be undone.");
      if (confirmClear) {
        localStorage.removeItem("habitUsers");
        localStorage.removeItem("lastUser");
    
        // Clear all hasOnboarded_ keys
        Object.keys(localStorage).forEach(key => {
          if (key.startsWith("hasOnboarded_")) {
            localStorage.removeItem(key);
          }
        });
    
        alert("All user accounts and session data have been cleared.");
        location.reload(); // reload page to reset everything
      }
    }

    window.onload = function () {
    const storedUser = localStorage.getItem("lastUser");
    if (storedUser && localStorage.getItem("hasOnboarded_" + storedUser) === "true") {
      userName = storedUser;
  
      document.getElementById("auth-section").style.display = "none";
      document.getElementById("login-section").style.display = "none";
      document.getElementById("onboarding").style.display = "none";
      document.getElementById("dashboard").style.display = "block";
      document.getElementById("chatbot").style.display = "block";
  
      document.getElementById("displayName").innerText = userName;
      document.getElementById("displayGoal").innerText = "Welcome back!";
      document.getElementById("userTitle").innerText = `${userName}'s habits`;
      document.getElementById("userTitle").style.display = "block";
    }
  };
    window.onerror = function (msg, url, line, col, error) {
      alert("⚠️ JS Error: " + msg + " on line " + line);
    };
  function prepareStart() {
    if (selectedShortTermGoals.length === 0) {
      alert("Pick at least one habit to continue!");
      return;
    }
    document.getElementById("quiz-step-3").style.display = "none";
    document.getElementById("startBtn").style.display = "inline-block";
  }

  </script>
</body>
</html>
